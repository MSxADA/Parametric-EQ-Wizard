import React, { useState, useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

// --- Helper Functions & Data ---

// Genre and profile preset data based on audiophile and audio science research
const genrePresets = {
  'Flat': [],
  'Fuller Bass & Warmth': [
      { type: 'Low Shelf', freq: 100, gain: 2.5, q: 0.7 },
      { type: 'Peak', freq: 250, gain: 1.5, q: 1.0 },
      { type: 'Peak', freq: 500, gain: -1.0, q: 1.4 },
  ],
  'Energetic & Forward': [
      { type: 'Peak', freq: 120, gain: 1.5, q: 0.8 },
      { type: 'Peak', freq: 2000, gain: 2.0, q: 1.2 },
      { type: 'Peak', freq: 5000, gain: 2.5, q: 1.0 },
      { type: 'High Shelf', freq: 8000, gain: 1.5, q: 0.7 },
  ],
  'Crisp Vocals & Detail': [
      { type: 'High Pass', freq: 80, gain: 0, q: 0.7 },
      { type: 'Peak', freq: 1500, gain: -1.5, q: 1.5 },
      { type: 'Peak', freq: 3500, gain: 2.5, q: 1.8 },
      { type: 'Peak', freq: 6000, gain: 2.0, q: 2.0 },
      { type: 'High Shelf', freq: 10000, gain: 1.5, q: 0.9 },
  ],
  'Smooth & Relaxed': [
      { type: 'Peak', freq: 3000, gain: -1.5, q: 1.5 },
      { type: 'Peak', freq: 5000, gain: -2.0, q: 1.2 },
      { type: 'High Shelf', freq: 8000, gain: -1.0, q: 0.7 },
  ],
  'Late Night Listening': [
      { type: 'Low Shelf', freq: 150, gain: 3.0, q: 0.6 },
      { type: 'High Shelf', freq: 6000, gain: -2.5, q: 0.8 },
      { type: 'Peak', freq: 10000, gain: -3.0, q: 1.5 },
  ],
  'Theater (Movies)': [
      { type: 'High Pass', freq: 40, gain: 0, q: 0.7 },
      { type: 'Low Shelf', freq: 80, gain: 3.0, q: 0.7 },
      { type: 'Peak', freq: 2500, gain: 2.0, q: 1.4 },
      { type: 'High Shelf', freq: 12000, gain: 2.5, q: 0.8 },
  ],
  'Classic Rock': [
      { type: 'Peak', freq: 100, gain: 2.0, q: 0.7 },
      { type: 'Peak', freq: 400, gain: -2.0, q: 1.2 },
      { type: 'Peak', freq: 3000, gain: 2.5, q: 1.1 },
      { type: 'High Shelf', freq: 8000, gain: 1.5, q: 0.7 },
  ],
  'Pop': [
      { type: 'Low Shelf', freq: 80, gain: 2.5, q: 0.7 },
      { type: 'Peak', freq: 2000, gain: -1.5, q: 1.5 },
      { type: 'Peak', freq: 5000, gain: 2.0, q: 1.2 },
      { type: 'High Shelf', freq: 12000, gain: 3.0, q: 0.7 },
  ],
  'Jazz': [
      { type: 'Peak', freq: 80, gain: 1.5, q: 0.8 },
      { type: 'Peak', freq: 500, gain: -1.0, q: 1.0 },
      { type: 'Peak', freq: 2500, gain: 2.0, q: 1.2 },
      { type: 'High Shelf', freq: 8000, gain: 1.5, q: 0.7 },
  ],
  'Metal': [
      { type: 'Peak', freq: 100, gain: 3.0, q: 0.9 },
      { type: 'Peak', freq: 400, gain: -4.0, q: 1.4 },
      { type: 'Peak', freq: 3000, gain: 3.5, q: 1.2 },
      { type: 'Peak', freq: 5000, gain: 2.0, q: 1.5 },
  ],
  'Stoner Metal': [
      { type: 'Peak', freq: 80, gain: 4.0, q: 0.8 },
      { type: 'Peak', freq: 250, gain: 2.0, q: 1.0 },
      { type: 'Peak', freq: 1000, gain: -3.0, q: 1.2 },
      { type: 'Peak', freq: 4000, gain: 2.5, q: 1.5 },
  ],
  'Acoustic': [
      { type: 'High Pass', freq: 80, gain: 0, q: 0.7 },
      { type: 'Peak', freq: 150, gain: 1.5, q: 0.9 },
      { type: 'Peak', freq: 400, gain: -2.0, q: 1.8 },
      { type: 'Peak', freq: 2500, gain: 2.0, q: 1.5 },
      { type: 'High Shelf', freq: 10000, gain: 1.5, q: 0.8 },
  ],
  'Classical': [
      { type: 'Low Shelf', freq: 120, gain: -1.0, q: 0.7 },
      { type: 'Peak', freq: 3000, gain: 1.5, q: 1.5 },
      { type: 'High Shelf', freq: 7000, gain: 1.0, q: 0.7 },
  ],
  'Electronic/Dance': [
      { type: 'Low Shelf', freq: 60, gain: 3.5, q: 0.7 },
      { type: 'Peak', freq: 250, gain: -2.0, q: 1.4 },
      { type: 'Peak', freq: 7000, gain: 2.5, q: 1.1 },
      { type: 'High Shelf', freq: 14000, gain: 3.0, q: 0.7 },
  ],
  'R&B': [
      { type: 'Low Shelf', freq: 90, gain: 3.0, q: 0.7 },
      { type: 'Peak', freq: 400, gain: -1.5, q: 1.2 },
      { type: 'Peak', freq: 5000, gain: 2.0, q: 1.3 },
      { type: 'High Shelf', freq: 12000, gain: 2.5, q: 0.8 },
  ],
  'Rap': [
      { type: 'Peak', freq: 60, gain: 3.5, q: 0.8 },
      { type: 'Peak', freq: 200, gain: 1.5, q: 1.0 },
      { type: 'Peak', freq: 500, gain: -2.5, q: 1.4 },
      { type: 'Peak', freq: 4000, gain: 2.0, q: 1.5 },
  ],
  'Country': [
      { type: 'Peak', freq: 150, gain: 1.5, q: 0.9 },
      { type: 'Peak', freq: 800, gain: -1.0, q: 1.2 },
      { type: 'Peak', freq: 3000, gain: 2.0, q: 1.3 },
      { type: 'High Shelf', freq: 9000, gain: 1.5, q: 0.7 },
  ],
  'Funk & Soul': [
      { type: 'Peak', freq: 80, gain: 2.5, q: 0.8 },
      { type: 'Peak', freq: 600, gain: -1.5, q: 1.2 },
      { type: 'Peak', freq: 4000, gain: 2.0, q: 1.4 },
      { type: 'High Shelf', freq: 11000, gain: 2.0, q: 0.7 },
  ],
  'Reggae': [
      { type: 'Peak', freq: 60, gain: 4.0, q: 0.7 },
      { type: 'Peak', freq: 120, gain: -2.0, q: 1.5 },
      { type: 'Peak', freq: 500, gain: -3.0, q: 1.4 },
      { type: 'Peak', freq: 3000, gain: 2.0, q: 2.0 },
  ],
};


// Frequencies for plotting the curve (logarithmic scale)
const FREQUENCIES = [
  20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500, 630, 800,
  1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300, 8000, 10000, 12500,
  16000, 20000,
];

/**
 * Calculates the gain at a specific frequency for a single parametric EQ filter.
 * This uses standard biquad filter transfer function calculations.
 * @param {number} plotFreq - The frequency to calculate the gain for.
 * @param {object} filter - The EQ filter object { type, freq, gain, q }.
 * @returns {number} The gain in dB at plotFreq.
 */
const calculateGainForFilter = (plotFreq, filter) => {
  const { type, freq, gain, q } = filter;
  const Fs = 44100; // Assume standard sample rate

  const w0 = 2 * Math.PI * freq / Fs;
  const cos_w0 = Math.cos(w0);
  const sin_w0 = Math.sin(w0);
  const alpha = sin_w0 / (2 * q);
  const A = 10 ** (gain / 40);

  let b0, b1, b2, a0, a1, a2;

  switch (type) {
    case 'Peak':
      b0 = 1 + alpha * A;
      b1 = -2 * cos_w0;
      b2 = 1 - alpha * A;
      a0 = 1 + alpha / A;
      a1 = -2 * cos_w0;
      a2 = 1 - alpha / A;
      break;
    case 'Low Shelf':
      b0 = A * ((A + 1) - (A - 1) * cos_w0 + 2 * Math.sqrt(A) * alpha);
      b1 = 2 * A * ((A - 1) - (A + 1) * cos_w0);
      b2 = A * ((A + 1) - (A - 1) * cos_w0 - 2 * Math.sqrt(A) * alpha);
      a0 = (A + 1) + (A - 1) * cos_w0 + 2 * Math.sqrt(A) * alpha;
      a1 = -2 * ((A - 1) + (A + 1) * cos_w0);
      a2 = (A + 1) + (A - 1) * cos_w0 - 2 * Math.sqrt(A) * alpha;
      break;
    case 'High Shelf':
      b0 = A * ((A + 1) + (A - 1) * cos_w0 + 2 * Math.sqrt(A) * alpha);
      b1 = -2 * A * ((A - 1) + (A + 1) * cos_w0);
      b2 = A * ((A + 1) + (A - 1) * cos_w0 - 2 * Math.sqrt(A) * alpha);
      a0 = (A + 1) - (A - 1) * cos_w0 + 2 * Math.sqrt(A) * alpha;
      a1 = 2 * ((A - 1) - (A + 1) * cos_w0);
      a2 = (A + 1) - (A - 1) * cos_w0 - 2 * Math.sqrt(A) * alpha;
      break;
    case 'High Pass':
        b0 = (1 + cos_w0) / 2;
        b1 = -(1 + cos_w0);
        b2 = (1 + cos_w0) / 2;
        a0 = 1 + alpha;
        a1 = -2 * cos_w0;
        a2 = 1 - alpha;
        break;
    default:
      return 0;
  }
  
  const omega = 2 * Math.PI * plotFreq / Fs;
  const cos_omega = Math.cos(omega);
  const sin_omega = Math.sin(omega);

  const phi = sin_omega * sin_omega;
  const real = b0 + b1 * cos_omega + b2 * (2 * cos_omega * cos_omega - 1);
  const imag = b1 * sin_omega + b2 * 2 * sin_omega * cos_omega;
  
  const num = real * real + imag * imag;

  const real_a = a0 + a1 * cos_omega + a2 * (2 * cos_omega * cos_omega - 1);
  const imag_a = a1 * sin_omega + a2 * 2 * sin_omega * cos_omega;

  const den = real_a * real_a + imag_a * imag_a;

  return 10 * Math.log10(num / den);
};


/**
 * Calculates the total gain at a specific frequency from all active filters.
 * @param {number} plotFreq - The frequency to calculate the gain for.
 * @param {array} filters - Array of active EQ filter objects.
 * @returns {number} The total gain in dB.
 */
const calculateTotalGain = (plotFreq, filters) => {
  if (!filters || filters.length === 0) {
    return 0;
  }
  return filters.reduce((totalGain, filter) => totalGain + calculateGainForFilter(plotFreq, filter), 0);
};


// --- React Components ---

const GenreSelector = ({ selectedGenre, onGenreChange }) => (
  <div className="w-full mb-8">
    <h2 className="text-2xl font-bold text-pink-300 mb-4 tracking-wider text-center uppercase">Select a Preset</h2>
    <div className="flex flex-wrap justify-center gap-3">
      {Object.keys(genrePresets).map((genre) => (
        <button
          key={genre}
          onClick={() => onGenreChange(genre)}
          className={`px-4 py-2 text-sm font-semibold rounded-full transition-all duration-300 ease-in-out border-2
            ${selectedGenre === genre 
              ? 'bg-pink-500 text-gray-900 border-pink-500 shadow-lg shadow-pink-500/50' 
              : 'bg-gray-800/50 text-cyan-300 border-cyan-400/50 hover:bg-pink-500 hover:text-gray-900 hover:border-pink-500 hover:shadow-md hover:shadow-pink-500/30'
            }`}
        >
          {genre}
        </button>
      ))}
    </div>
  </div>
);

const EQChart = ({ data }) => (
    <div className="w-full h-64 md:h-80 bg-gray-900/50 p-4 rounded-2xl shadow-inner-strong border border-gray-700 mb-8 backdrop-blur-sm">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart
          data={data}
          margin={{ top: 5, right: 30, left: -20, bottom: 20 }}
        >
          <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
          <XAxis 
            dataKey="freq" 
            type="log" 
            domain={['dataMin', 'dataMax']}
            scale="log"
            ticks={[30, 100, 1000, 10000]}
            tickFormatter={(tick) => tick >= 1000 ? `${tick/1000}k` : tick}
            label={{ value: 'Frequency (Hz)', position: 'insideBottom', offset: -10, fill: '#9ca3af' }}
            stroke="#9ca3af"
          />
          <YAxis 
            domain={[-8, 8]} 
            allowDataOverflow={true}
            ticks={[-6, -3, 0, 3, 6]}
            label={{ value: 'Gain (dB)', angle: -90, position: 'insideLeft', fill: '#9ca3af' }}
            stroke="#9ca3af"
          />
          <Tooltip 
            contentStyle={{
              backgroundColor: 'rgba(31, 41, 55, 0.8)',
              borderColor: '#6b7280',
              color: '#e5e7eb'
            }}
            formatter={(value, name, props) => [`${value.toFixed(2)} dB`, 'Gain']}
            labelFormatter={(label) => `${label.toFixed(0)} Hz`}
          />
          <Legend wrapperStyle={{ color: '#e5e7eb' }} />
          <Line type="monotone" dataKey="gain" stroke="#f472b6" strokeWidth={3} dot={false} name="Response Curve" />
        </LineChart>
      </ResponsiveContainer>
    </div>
);

const ParametricEQTable = ({ filters }) => (
  <div className="w-full">
    <h2 className="text-2xl font-bold text-pink-300 mb-4 tracking-wider text-center uppercase">Parametric EQ Settings</h2>
    <div className="overflow-x-auto bg-gray-900/50 p-4 rounded-2xl shadow-inner-strong border border-gray-700 backdrop-blur-sm">
      <table className="min-w-full text-left text-sm text-gray-300">
        <thead className="border-b border-gray-600">
          <tr>
            <th className="p-3 text-cyan-300">Filter Type</th>
            <th className="p-3 text-cyan-300">Frequency (Hz)</th>
            <th className="p-3 text-cyan-300">Gain (dB)</th>
            <th className="p-3 text-cyan-300">Q Factor</th>
          </tr>
        </thead>
        <tbody>
          {filters.length > 0 ? filters.map((filter, index) => (
            <tr key={index} className="border-b border-gray-700 last:border-b-0">
              <td className="p-3 font-mono">{filter.type}</td>
              <td className="p-3 font-mono">{filter.freq}</td>
              <td className="p-3 font-mono">{filter.gain.toFixed(1)}</td>
              <td className="p-3 font-mono">{filter.q.toFixed(1)}</td>
            </tr>
          )) : (
            <tr>
              <td colSpan="4" className="p-4 text-center text-gray-400">Select a preset to see its parameters. The "Flat" setting has no filters.</td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  </div>
);


// --- Main App Component ---

export default function App() {
  const [selectedGenre, setSelectedGenre] = useState('Flat');

  const activeFilters = useMemo(() => genrePresets[selectedGenre] || [], [selectedGenre]);

  const chartData = useMemo(() => {
    return FREQUENCIES.map(freq => ({
      freq: freq,
      gain: calculateTotalGain(freq, activeFilters),
    }));
  }, [activeFilters]);

  return (
    <div className="bg-gray-900 min-h-screen text-white font-sans p-4 sm:p-8 flex items-center justify-center">
       <div 
        className="absolute inset-0 z-0" 
        style={{
          backgroundImage: 'linear-gradient(to bottom right, #1f2937, #111827, #000)',
          opacity: 0.8
        }}>
      </div>
      <div 
        className="absolute top-0 left-0 w-full h-full z-10"
        style={{
          background: 'radial-gradient(circle at 10% 20%, rgba(219, 39, 119, 0.15) 0%, transparent 40%), radial-gradient(circle at 80% 90%, rgba(56, 189, 248, 0.15) 0%, transparent 40%)',
        }}
      ></div>

      <main className="w-full max-w-4xl mx-auto z-20">
        <header className="text-center mb-10">
          <h1 className="text-4xl md:text-5xl font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-cyan-300">
            WiiM EQ Preset Visualizer
          </h1>
          <p className="text-gray-400 mt-2">
            Select a preset to visualize the EQ curve and see the parameters to replicate on your WiiM Ultra.
          </p>
        </header>

        <GenreSelector selectedGenre={selectedGenre} onGenreChange={setSelectedGenre} />
        
        <EQChart data={chartData} />
        
        <ParametricEQTable filters={activeFilters} />

        <footer className="text-center mt-10 text-gray-500 text-xs">
            <p>Presets are based on general audiophile recommendations and audio science principles. Use them as a starting point and adjust to your personal preference and equipment.</p>
            <p className="mt-1">&copy; 2024. For educational and personal use.</p>
        </footer>
      </main>
    </div>
  );
}
